- name: ðŸš€ Build APK and AAB
        env:
          BUBBLEWRAP_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          BUBBLEWRAP_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # Â¡AQUÃ ESTÃ LA MAGIA! Cambiamos "n" por "y". 
          # Esto obliga al servidor a crear los archivos de Android antes de compilar.
          echo "y" | bubblewrap build \
            --skipPwaValidation \
            --keyStore ./elishama.keystore \
            --alias elishama_alias \
            --verbose
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ðŸ› ï¸ Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli
      
      - name: ðŸ”‘ Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          # Decodificamos el archivo fÃ­sico del Keystore temporalmente
          echo "$KEYSTORE_BASE64" | base64 -d > elishama.keystore
      
      - name: ðŸ“ Configure Bubblewrap
        run: |
          mkdir -p "$HOME/.bubblewrap"
          # Le decimos a Bubblewrap dÃ³nde estÃ¡n Java y el SDK de Android
          echo "{\"jdkPath\":\"$JAVA_HOME\",\"androidSdkPath\":\"$ANDROID_HOME\"}" > "$HOME/.bubblewrap/config.json"
      
      - name: ðŸš€ Build APK and AAB
        env:
          # Bubblewrap lee nativamente estas variables para no pedir contraseÃ±as interactivamente
          BUBBLEWRAP_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          BUBBLEWRAP_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # Usamos 'echo "n"' para enviar un UNICO "no" y evitar el error de Broken Pipe.
          # AÃ±adimos --verbose para ver los detalles si algo falla.
          echo "n" | bubblewrap build \
            --skipPwaValidation \
            --keyStore ./elishama.keystore \
            --alias elishama_alias \
            --verbose
      
      - name: ðŸ§¹ Clean up Keystore (Security)
        if: always() # Garantiza que se borre incluso si el build falla
        run: rm -f ./elishama.keystore

      - name: ðŸ“¤ Upload Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: elishama-android-builds
          path: |
            *.aab
            *.apk
          retention-days: 30
